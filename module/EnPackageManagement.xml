<?xml version="1.0" encoding="utf-8"?>
<module name="Packages" type="onload" trigger="ItemMasterList">
  <!--Item Master Maintenance -->
 <section type="tab" title="Item Master Packages"	>
  <group>
    <row showif="never">
      <control type="select" name="ItemCategories"
        acctsvc="true"
        datasource="GetItemMasterCategoriesByFacilityActive"
        default="Packages"
        source="CategoryDescription,ItemCategoryGuid"/>
    </row>
    <!-- Display a list of packages -->
    <row>
      <control type="datagrid"
        search="true"
        name="ItemMasterList"
        label="Item Master"	
        span="12" rows="25"
        action="redirect"
        target="ItemMasterModal"
        searchable="true"
        acctsvcreq="true"
        idle="ItemCategories="
        datarequest="GetItemMasterNamesForThisFacility"
        appendrequest="Category=[ItemCategories]"
        source="Status,ItemNumber,ItemName,ItemDescription,Notes"
        sourcelabels="Active,Code,Item,Description,Notes"	
        translate="Status"
        align="left|left|left|left|left"
        sort="ItemName=asc"
        key="ItemMasterGuid"
        onselectset="ItemMasterGuid=[[ItemMasterGuid]]"
        onselect="ItemMasterGuid"> 
        <!-- Enter new items -->
        <control type="button" name="btnNewItem"
          reveal="[ItemCategories]!"
          label="Add New"	
          icon="plus"
          action="redirect"
          preset="CategoryGuid=[ItemCategories]"
          target="ItemMasterModal"/>
      </control>
    </row>
  </group>
</section>
  
<!-- Item Master tabmodal enter and edit Item Master Items -->
<section type="tabmodal" badge="none" name="ItemMasterModal" title="Package"	>
    <group name="ItemMasterGuidGroup" showif="never">
      <row>        
        <!-- Get the item and inject to the Item Master screen -->
        <control type="hidden" span="7"
          name="ItemMasterGuid" 
          acctsvcreq="true"
          datarequest="GetItemByItemGuid"
          appendrequest="ItemMasterGuid=[ItemMasterGuid]"
          inject="ItemInfo,HiddenFields"
          provoke="KitItems"/>
      </row>
      <row>
        <!-- Save the item prior to printing -->
        <control type="button" name="btnSaveItemToPrint"
          action="save"
          affector="none"
          capture="ItemInfo"
          acctsvc="true"
          dataupdate="UpdateItemMasterItem"
          appendupdate="itemMasterGuid=[ItemMasterGuid]"
          provoke="RunPackagePrint"/>
      </row>
    </group>

    <!-- Item Master information -->
    <group name="ItemInfo">
      <columns>
        <column span="10">     
          <row>
            <control type="hidden" name="CategoryGuid"/>
          </row> 
          <row>
            <!-- Set the Active status for the item -->
            <control type="label" span="2" label="Active"	/>
            <control type="buttongroup" span="3" name="Status"
              required="true" edit="true" source="Active,Canceled" sourcelabels="Yes,No"	 default="Active"/>
            <control type="label" span="4" label="Patient Charge"	/>        
            <control type="buttongroup" span="3" name="PatientChargeable"
              sourcelabels="Yes,No"	 source="True,False"  default="True" edit="true"  required="true" /> 
          </row>   
          <row>
            <!-- Item number -->
            <control type="label" span="2" label="Item Code"	/>
            <control type="text" span="4" name="ItemInfo_ItemNumber"  edit="true" required="true" />
          </row>
          <row>
            <control type="label" span="2" label="Name"	/>        
            <control type="textarea" span="10" name="ItemInfo_ItemName" rows="1" required="true" edit="true" /> 
          </row>
          <row>
            <!-- A description of the item  will appear on Purchase Orders  and is optional-->
            <control type="label" span="2" label="Description"	/>        
            <control type="textarea" span="10" rows="1" name="ItemInfo_ItemDescription" edit="true" />
          </row>
          <row>         
            <control type="label" label="Base Price"	 span="2"/>        
            <control type="text" name="BasePrice" span="3" edit="true" format="0,00.00" default="0.00"/>                   
            <control type="label" label="Last Update"	 span="4"/>        
            <control type="date" name="DateTimeLastPriceUpdate" span="3" edit="true"/> 
          </row>      
          <!-- IVA taxable -->
          <row>
            <control type="label" label="Generate VAT"	 span="2"/>
            <control type="buttongroup" name="ItemInfo_Taxable" span="3"
            sourcelabels="Yes,No"	 source="True,False" default="False" edit="true" required="true"/> 
            <control type="label" span="4" label="VAT Rate"	/>        
            <control type="text" span="3" name="ItemInfo_TaxRate" edit="true" format="0.00"/>
          </row>
          <row>
            <!-- Note field -->
            <control type="label" label="Notes"	 span="2" />       
            <control type="textarea" name="ItemInfo_Notes" span="10" rows="2" edit="true"  />
          </row>
        </column>
        <column span="2">
            <!-- Save and update buttons -->
          <row name="rowUpdate" reveal="[ItemMasterGuid]!">
            <control type="button" name="btnUpdatePackage"
              span="12" 
              label="Update"	 icon="cloud-upload"
              action="save|close|new"
              affector="none"
              capture="ItemInfo"
              acctsvc="true"
              dataupdate="UpdateItemMasterItem"
              appendupdate="itemMasterGuid=[ItemMasterGuid],isPackage=true,isKit=false"
              provoke="ItemMasterList"/>
          </row>
          <row name="rowNew" reveal="[ItemMasterGuid]=">
            <control type="button" name="btnSavePackage"
              span="12" 
              label="Generate"	 icon="cloud-upload"
              action="save"
              affector="ItemMasterGuid"
              setaffector="ItemMasterGuid"
              capture="ItemInfo"
              acctsvc="true"
              datainsert="InsertItemMasterItem"
              appendinsert="isPackage=true,isKit=false"
              provoke="ItemMasterList,KitItems"/>
          </row>
        </column>
      </columns> 
    </group>
    <!-- Kit item list for package -->
    <group name="kitItemsList" reveal="ItemMasterGuid!">
      <row>
        <control type="datagrid" label="Package Items"	 name="KitItems" 
          edit="true" rows="10" span="12"
          modalname="NewKitItem"
          source="Active,ItemNumber,ItemName,ItemDescription,ItemCount,Notes"
          sourcelabels="Active,Item Number,Item Name,Item Description,Quantity,Notes"	
          acctsvc="true"
          acctsvcreq="true"
          datainsert="InsertKitItem"
          appendinsert="kitGuid=[ItemMasterGuid]"
          dataupdate="UpdateKitItem"
          datarequest="GetKitItemsByKitGuidActive"
          appendrequest="kitGuid=[ItemMasterGuid]"
          format="boolean||||0,000"
          align="|left|left|left|right|left"
          sort="ItemName=asc"
          key="KitItemGuid"/>
      </row>
    </group>    
  </section>
  <!-- Package item modal -->
  <section type="modal" title="Package Items"	 name="NewKitItem"  size="small" badge="none"
      enteredby="EnteredByFullName" updatedby="UpdatedByFullName"
      dtentered="DateTimeEntered" dtupdated="DateTimeUpdated">
    <group name="NewKitItemSelect">
      <row>
        <control type="label" label="Active"	 span="2"/>
        <control type="buttongroup" name="NewKitItemSelect_Active" sourcelabels="Yes,No"	
          source="True,False" span="2" edit="true" default="True"/>      
      </row>
      <row>
        <control type="label" label="Item"	 span="2"/>
        <control type="select" name="NewKitItem_ItemGuid" span="10" placeholder="Search artículo ..."
          source="ItemName,ItemMasterGuid" searchable="true"
          acctsvc="true" edit="true"
          filter="Category![ItemCategories]"
          datasource="GetItemMasterNamesForThisFacility"
          required="true"/>
      </row>
      <row>        
        <control type="label" label="Quantity"	 span="2"/>
        <control type="text" injectname="ItemCount" name="NewKitItem_ItemCount"  span="1" default="1" 
        format="0,000" required="true" edit="true"/>   
      </row>
      <row>
        <control type="label" span="2" label="Notes"	/>
        <control type="textarea" rows="2" span="10" name="NewKitItem_Notes" edit="true" />
      </row>
      <row>
        <control type="modalbutton" 
          showif="edit"
          name="mdlbtn_UpdateItemAndNext" 
          label="Next"	
          color="grey"
          icon="circle-arrow-right"
          modaltask="update|next" />
      </row>
      <row>
        <control type="modalbutton" 
          showif="add"
          name="mdlbtn_NewItemAndNext" 
          label="Next"	
          color="grey"
          icon="circle-arrow-right"
          modaltask="insert|add"/>
      </row>
   </group> 
  </section>   
</module>
